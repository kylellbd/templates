<!DOCTYPE html>
<html lang="en">
<!--<![endif]-->
<!-- BEGIN HEAD -->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="import" href="/templates/adm/commCss.html">
    <title>입/출금관리</title>
    <link rel="shortcut icon" href="favicon.ico" />
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-sidebar-closed-hide-logo page-content-white">
    <div class="page-wrapper">
        <!-- BEGIN HEADER -->
        <div class="page-header navbar navbar-fixed-top">
            <!-- BEGIN HEADER INNER -->
            <div class="page-header-inner ">
                <!-- BEGIN LOGO -->
                <div class="page-logo">
                    <a href="/templates/adm/index.html">
                        <img src="" alt="logo" class="logo-default" /> </a>
                    <div class="menu-toggler sidebar-toggler">
                        <span></span>
                    </div>
                </div>
                <!-- END LOGO -->
                <!-- BEGIN RESPONSIVE MENU TOGGLER -->
                <a href="javascript:;" class="menu-toggler responsive-toggler" data-toggle="collapse" data-target=".navbar-collapse">
                    <span></span>
                </a>
                <!-- END RESPONSIVE MENU TOGGLER -->
                <!-- BEGIN TOP NAVIGATION MENU -->
                <div class="top-menu">
                    <ul class="nav navbar-nav pull-right">
                        <!-- END USER LOGIN DROPDOWN -->
                        <!-- BEGIN QUICK SIDEBAR TOGGLER -->
                        <!-- DOC: Apply "dropdown-dark" class after below "dropdown-extended" to change the dropdown styte -->
                        <li>
                            <p style="color: white">Welcome Loginer</p>
                        </li>
                        <li class="dropdown dropdown-quick-sidebar-toggler">
                            <a href="javascript:;" class="dropdown-toggle">
                                <i class="icon-logout"></i>
                            </a>
                        </li>
                        <!-- END QUICK SIDEBAR TOGGLER -->
                    </ul>
                </div>
                <!-- END TOP NAVIGATION MENU -->
            </div>
            <!-- END HEADER INNER -->
        </div>
        <!-- END HEADER -->
        <!-- BEGIN HEADER & CONTENT DIVIDER -->
        <div class="clearfix"> </div>
        <!-- END HEADER & CONTENT DIVIDER -->
        <!-- BEGIN CONTAINER -->
        <div class="page-container">
            <!-- BEGIN SIDEBAR -->
            <div class="page-sidebar-wrapper">
                <div class="page-sidebar navbar-collapse collapse">
                    <ul id="ul_menu" class="page-sidebar-menu  page-header-fixed " data-keep-expanded="false" data-auto-scroll="true" data-slide-speed="200" style="padding-top: 20px">


                    </ul>
                </div>
            </div>
            <!-- END SIDEBAR -->

            <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content">
                    <!-- BEGIN PAGE HEADER-->
                    <!-- BEGIN PAGE TITLE-->
                    <h1 class="page-title"> 입/출금관리
                        <!-- <small>...</small> -->
                    </h1>
                    <!-- END PAGE TITLE-->
                    <!-- END PAGE HEADER-->
                    <!-- BEGIN DASHBOARD STATS 1-->
                    <div class="clearfix"></div>
                    <!-- END DASHBOARD STATS 1-->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="portlet light portlet-fit bordered">

                                <div class="portlet-title" style="background-color: #E9EDEF">
                                    <form action="#" class="form-horizontal" id="depositForm" novalidate="novalidate">
                                        <div class="form-body">

                                            <div class="form-group" style="margin-bottom:0px">
                                                <label class="col-md-1 control-label" for="form_control_1">
                                                                            <span class="required" aria-required="true"></span>조회일자
                                                                        </label>
                                                <div class="col-md-2 input-icon right">
                                                    <div class="input-group input-large date-picker input-daterange" data-date="10/11/2012" data-date-format="yyyy/mm/dd">
                                                        <input type="text" class="form-control from" name="from" readonly>
                                                        <span class="input-group-addon"> ~ </span>
                                                        <input type="text" class="form-control to" name="to" readonly>
                                                    </div>
                                                </div>
                                                <label class="col-md-2 control-label" for="form_control_1">
                                                            <span class="required" aria-required="true"></span>입/출금구분
                                                        </label>
                                                <div class="col-md-1 input-icon right">
                                                    <select class="bs-select form-control balanceType">
                                                                <option value="">--선택--</option>
                                                                <option value="0001">입금</option>
                                                                <option value="0002">출금</option>
                                                            </select>
                                                </div>

                                                <label class="col-md-1 control-label" for="form_control_1">
                                                            <span class="required" aria-required="true"></span>진행상태
                                                        </label>
                                                <div class="col-md-1 input-icon right">
                                                    <select class="bs-select form-control sts">
                                                                <option value="">--선택--</option>
                                                                <option value="0001" selected>신청</option>
                                                                <option value="0002">완료</option>
                                                                <option value="0003">반려</option>
                                                            </select>
                                                </div>
                                                <div class="col-md-4  hei">
                                                    <div style="float: right;margin-right: 10px;">
                                                        <button type="button" class="btn green-haze btn-outline sbold uppercase dark DepositReset">Reset</button>
                                                        <button type="button" class="btn green-haze btn-outline sbold uppercase dark DepositSearch">조회</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                    <div>&nbsp;</div>
                                </div>
                                <div class="portlet-body">

                                    <table id="table_deposit" class=""></table>
                                    <div id="modal_recharge" class="modal fade" tabindex="-1" data-width="700" data-backdrop="static" data-keyboard="false">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                            <h3 class="modal-title">입금신청처리</h3>
                                        </div>
                                        <div class="modal-body">
                                            <div class="portlet box ">
                                                <div class="portlet-body form">
                                                    <!-- BEGIN FORM-->
                                                    <form id="rechargeForm" action="#" class="form-horizontal form-bordered form-row-stripped">
                                                        <div class="form-body">
                                                            <div class="form-group col-md-12" style="background-color: #e5e8ed">
                                                                <label class="control-label col-md-12" style="text-align: center; padding-bottom: 20px;">
                                                                                                <b>입금정보</b></label>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="control-label col-md-3">입금자명</label>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" value="" data-key="ACCOUNTNAME" data-type="TEXT" readonly/>
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="control-label col-md-3">계좌번호</label>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" value="" data-key="ACCOUNTNO" data-type="TEXT" readonly/>
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="col-md-3 control-label">입금액</label>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" value="" data-key="REQUESTMONEY" data-type="MONEY" data-inputmask="'alias':'currency_normal'" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="col-md-3 control-label">고객전달사항</label>
                                                                <div class="col-md-9">
                                                                    <textarea class="form-control" rows="3" data-key="CUSTMEMO" data-type="TEXT" readonly></textarea>
                                                                </div>
                                                            </div>
                                                            <div class="form-group col-md-12" style="background-color: #e5e8ed">
                                                                <label class="control-label col-md-12" style="text-align: center; padding-bottom: 20px;">
                                                                                                    <b>처리정보</b></label>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="col-md-3 control-label">처리결과상태</label>
                                                                <div class="col-md-9">
                                                                    <select class="form-control" data-key="rechargeSts" data-type="SELECT" name="rechargeSts">
                                                                            <option value="">--선택--</option>
                                                                            <option value="0002">Finished</option>
                                                                            <option value="0003">Rejected</option>
                                                                        </select>
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="col-md-3 control-label">처리금액</label>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" value="" data-key="rechargeMoney" data-type="MONEY" data-inputmask="'alias':'currency_normal'">
                                                                </div>
                                                            </div>

                                                            <div class="form-group">
                                                                <label class="col-md-3 control-label">처리사항</label>
                                                                <div class="col-md-9">
                                                                    <textarea class="form-control" rows="3" data-key="rechargeMemo" data-type="TEXT"></textarea>
                                                                    <input type="hidden" value="" data-key="ACCESSSEQ" data-type="TEXT" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="modal-footer">
                                            <button type="button" data-dismiss="modal" class="btn btn-outline dark">취소</button>
                                            <button id="rechargeBtn" type="button" class="btn green">입금처리</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
        </div>
        <!-- END CONTAINER -->
        <!-- BEGIN FOOTER -->
        <div class="page-footer">
            <div class="page-footer-inner"> 2019 &copy; By Kyle.Moon
            </div>
            <div class="scroll-to-top">
                <i class="icon-arrow-up"></i>
            </div>
        </div>
        <!-- END FOOTER -->
    </div>



    <link rel="import" href="/templates/adm/commJs.html">
    <script type="text/javascript">
    </script>
</body>

<script>
    $(function() {

        Comm.init();
        Deposit.init();
        $(".DepositReset").on("click", function() {

            Deposit.resetDepositCondition();

        });

        $(".DepositSearch").on("click", function() {

            Deposit.searchDeposit();

        });

        $("#rechargeBtn").on("click", function() {

            $("#rechargeForm").submit();

        });


    });



    var Deposit = function() {
        var make_table_deposit = function() {
            var header = Comm.getPostHeader();
            header.crossDomain = true;

            var table_deposit = $("#table_deposit").bootstrapTable("destroy").bootstrapTable({
                url: Comm.getApiUrl() + '/api/DepositWithDraw/QueryDepositOrWithDraw', // 请求后台的URL（*）
                method: 'post', // 请求方式（*）
                dataType: 'json',
                striped: true, // 是否显示行间隔色
                cache: false, // 是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                pagination: false, // 是否显示分页（*）
                sortable: false, // 是否启用排序
                sortOrder: "asc", // 排序方式
                sidePagination: "client", // 分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1, // 初始化加载第一页，默认第一页
                pageSize: 10, // 每页的记录行数（*）
                pageList: [10, 25, 50, 100], // 可供选择的每页的行数（*）
                search: false, // 是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
                contentType: "application/json",
                strictSearch: false,
                showColumns: false, // 是否显示所有的列
                showRefresh: false, // 是否显示刷新按钮
                minimumCountColumns: 2, // 最少允许的列数
                clickToSelect: false, // 是否启用点击选中行
                uniqueId: "ACCESSSEQ", // 每一行的唯一标识，一般为主键列
                showToggle: false, // 是否显示详细视图和列表视图的切换按钮
                cardView: false, // 是否显示详细视图
                detailView: false, // 是否显示父子表
                ajaxOptions: {
                    headers: header
                },
                queryParams: function(params) {
                    return {
                        // userId: header.user,
                        balanceType: $("#depositForm").find('.balanceType').val(),
                        sts: $("#depositForm").find('.sts').val(),
                        startDate: $("#depositForm").find('.from').val(),
                        endDate: $("#depositForm").find('.to').val()
                    }
                },
                columns: [{
                    field: 'REQUESTTIME',
                    title: '신청일시',
                    align: "center"
                }, {
                    field: 'EXECUTETIME',
                    title: '승인일시',
                    align: "center"
                }, {
                    field: 'BALANCETYPE',
                    title: '입금/출금구분',
                    align: "center"
                }, {
                    field: 'STS',
                    title: '진행상태',
                    align: "center"
                }, {
                    field: 'REQUESTMONEY',
                    title: '신청금액',
                    align: "center",
                    formatter: function(value, row, index) {
                        if (value == 'null' || value == "null" || value == null) {
                            return value;
                        }
                        // return value;
                        return Inputmask.format(value, {
                            alias: "currency_normal"
                        });

                    }
                }, {
                    field: 'EXECUTEMONEY',
                    title: '처리금액',
                    align: "center",
                    formatter: function(value, row, index) {
                        if (value == 'null' || value == "null" || value == null) {
                            return value;
                        }
                        // return value;
                        return Inputmask.format(value, {
                            alias: "currency_normal"
                        });

                    }
                }, {
                    field: 'MGMTUSERID',
                    title: '처리자',
                    align: "center"
                }, {
                    field: 'BANKNAME',
                    title: '은행',
                    align: "center"
                }, {
                    field: 'ACCOUNTNO',
                    title: '은행계좌',
                    align: "center"
                }, {
                    field: 'ACCOUNTNAME',
                    title: '예금주',
                    align: "center"
                }, {
                    field: 'CUSTMEMO',
                    title: '비고',
                    align: "center"
                }, {
                    title: 'Action',
                    align: "center",
                    formatter: function(value, row, index) {
                        var actionHtml = "";
                        if (row.STS == "신청") {
                            actionHtml = '<a class="green-color green-haze btn-outline" href="#"  onclick="Deposit.openRechargeModal(\'';
                            actionHtml += row.ACCESSSEQ;
                            actionHtml += '\')">입금처리</a>';
                        }

                        return actionHtml;
                    }
                }],
                onLoadSuccess: function() { // 加载成功时执行
                    console.log("加载成功");
                },
                onLoadError: function() { // 加载失败时执行
                    console.log("加载数据失败");
                },
                responseHandler: function(res) {

                    if (res.errorCode == '9001') {
                        Comm.alert('세션이 만료되었습니다.', 'error', '/templates/adm/login_cn.html');
                    }
                    var returnDatas = res.Data;
                    $.each(returnDatas, function(index, item) {
                        if (item.BALANCETYPE == "입금") {
                            item.BANKNAME = item.BANKFROM.BANKNAME;
                            item.ACCOUNTNO = item.BANKFROM.ACCOUNTNO;
                            item.ACCOUNTNAME = item.BANKFROM.ACCOUNTNAME;
                        } else {
                            item.BANKNAME = item.BANKTO.BANKNAME;
                            item.ACCOUNTNO = item.BANKTO.ACCOUNTNO;
                            item.ACCOUNTNAME = item.BANKTO.ACCOUNTNAME;
                        }
                    });

                    return returnDatas;
                },
            });
            return table_deposit;
        };

        function initModalForm() {

            $('#rechargeForm').validate({
                errorElement: 'span', //default input error message container
                errorClass: 'help-block', // default input error message class
                focusInvalid: false, // do not focus the last invalid input
                ignore: "",
                rules: {
                    rechargeSts: {
                        required: true
                    },

                },

                messages: { // custom messages for radio buttons and checkboxes
                    rechargeSts: {
                        required: "처리결과를 선택하세요."
                    },

                },

                invalidHandler: function(event, validator) { //display error alert on form submit   

                },

                highlight: function(element) { // hightlight error inputs
                    $(element)
                        .closest('.form-group').addClass('has-error'); // set error class to the control group
                },

                success: function(label) {
                    label.closest('.form-group').removeClass('has-error');
                    label.remove();
                },

                errorPlacement: function(error, element) {
                    if (element.closest('.input-icon').size() === 1) {
                        error.insertAfter(element.closest('.input-icon'));
                    } else {
                        error.insertAfter(element);
                    }
                },

                submitHandler: function(form) {
                    var header = Comm.getPostHeader();

                    var modal_item = Comm.getDomData($("#rechargeForm"));

                    console.log(modal_item);

                    var data = {
                        adminId: header.user,
                        accessSeq: modal_item.ACCESSSEQ,
                        sts: modal_item.rechargeSts,
                        money: modal_item.rechargeMoney,
                        memo: modal_item.rechargeMemo
                    }
                    var settings = {
                        "async": false,
                        "crossDomain": true,
                        "url": Comm.getApiUrl() + "/api/DepositWithDraw/ActiveDeposit",
                        "method": "POST",
                        "headers": header,
                        "data": JSON.stringify(data)
                    }

                    $.ajax(settings).done(function(response) {
                        console.log(response);
                        $("#modal_recharge").modal("hide");
                        if (response.Result == 0) {
                            Comm.alert('입금 요청 처리 되었습니다.', 'success');
                        } else {
                            Comm.alert(response.ErrorMsg, 'error');
                        }
                        $("#table_deposit").bootstrapTable("refresh");
                    });

                    return false;
                }
            });
        }



        return {
            init: function() {
                make_table_deposit();
                initModalForm();
            },
            openRechargeModal: function(ACCESSSEQ) {
                var rows = $('#table_deposit').bootstrapTable('getRowByUniqueId', ACCESSSEQ); //行的数据
                // console.log(rows);

                Comm.cleanDomData($("#modal_recharge"));
                Comm.setDomData($("#modal_recharge"), rows);

                $("#modal_recharge").modal("show");
            },
            resetDepositCondition: function() {

                $("#depositForm").find('.from').val("");
                $("#depositForm").find('.to').val("");
                $("#depositForm").find('.balanceType').val("");
                $("#depositForm").find('.sts').val("");
            },
            searchDeposit: function() {
                $("#table_deposit").bootstrapTable("refresh");
            },

        }
    }();
</script>

</html>